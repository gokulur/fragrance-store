{% extends 'admin_dashboard.html' %}
{% block content %}
<title>{% block title %}ORDER DETAILS{% endblock %}</title>
<style>
  /* Small screens */
@media print {
  table {
    width: 100% !important;
    border-collapse: collapse !important;
    table-layout: fixed; /* Keeps columns aligned */
  }

  table th, table td {
    border: 1px solid #000 !important;
    padding: 6px 8px !important; /* Same for th & td */
    font-size: 9px !important;
    vertical-align: top;
    text-align: left;
    word-wrap: break-word;
  }
}


  /* PDF/PRINT STYLES - ENHANCED */
  @media print {
    /* Hide unnecessary elements */
    .main-navbar,
    .sidebar,
    .navbar,
    .sidebar-offcanvas,
    .footer,
    .page-header,
    .btn,
    button,
    .actions,
    .action-buttons,
    .mdi,
    .nav,
    .navbar-brand,
    .profile-dropdown,
    .topbar,
    .search-field,
    .filter-section,
    .pagination,
    .export-buttons,
    .breadcrumb,
    .logo,
    .theme-toggle,
    .mobile-menu,
    .searchOrder,
    .control-row,
    .no-print,
    #toast-container {
      display: none !important;
      visibility: hidden !important;
    }

    /* Reset layout for print */
    body {
      background: #ffffff !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      margin: 0;
      padding: 20px;
    }

    .main-panel,
    .content-wrapper {
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
      background: #ffffff !important;
    }

    .card {
      box-shadow: none !important;
      border: none !important;
      background: #ffffff !important;
    }

    .card-body {
      padding: 0 !important;
    }

    /* Table print styles */
    .table-responsive {
      overflow: visible !important;
    }

    table {
      width: 100% !important;
      border-collapse: collapse !important;
      page-break-inside: auto;
    }

    table thead {
      display: table-header-group;
      background: #e9ecef !important;
    }

    table thead th {
      background: #e9ecef !important;
      color: #000 !important;
      border: 2px solid #000 !important;
      padding: 10px 6px !important;
      font-weight: 700 !important;
      font-size: 10px !important;
      text-align: left !important;
      text-transform: uppercase;
    }

    table tbody tr {
      page-break-inside: avoid;
      page-break-after: auto;
      border: 1px solid #000 !important;
    }

    table tbody td {
      border: 1px solid #000 !important;
      padding: 8px 6px !important;
      color: #000 !important;
      background: #fff !important;
      font-size: 9px !important;
      vertical-align: top !important;
    }

    /* Hide Status column in print */
    table thead th:nth-child(9),
    table tbody td:nth-child(9) {
      display: none !important;
    }

    /* Hide action buttons column in print */
    table thead th:last-child,
    table tbody td:last-child {
      display: none !important;
    }

    /* Hide checkbox column in print */
    table thead th:first-child,
    table tbody td:first-child {
      display: none !important;
    }

    /* Show items detail in print */
    .print-items-detail {
      display: block !important;
      margin-top: 4px;
      padding-top: 4px;
      border-top: 1px solid #ddd;
    }

    .print-item-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      padding: 4px;
      background: #f9f9f9;
      border-radius: 3px;
    }

    .print-item-image {
      width: 30px !important;
      height: 30px !important;
      object-fit: cover !important;
      border: 1px solid #000 !important;
      border-radius: 3px !important;
      display: block !important;
    }

    .print-item-info {
      flex: 1;
      font-size: 8px !important;
    }

    .print-item-name {
      font-weight: 700 !important;
      color: #000 !important;
      margin-bottom: 2px !important;
    }

    .print-item-details {
      color: #666 !important;
      font-size: 7px !important;
    }

    /* Address column enhanced */
    .print-address-full {
      display: block !important;
      font-size: 8px !important;
      line-height: 1.4 !important;
    }

    .print-address-full strong {
      display: block;
      margin-bottom: 2px;
      font-size: 9px !important;
    }

    /* Amount column - show breakdown */
    .print-amount-breakdown {
      display: block !important;
    }

    .print-amount-total {
      font-weight: 700 !important;
      font-size: 10px !important;
      color: #000 !important;
    }

    .print-amount-items {
      font-size: 7px !important;
      color: #666 !important;
      margin-top: 2px;
    }

    /* Badge styles for print */
    .badge {
      border: 1px solid #000 !important;
      padding: 3px 6px !important;
      font-size: 8px !important;
      color: #000 !important;
      background: #fff !important;
    }

    /* Print header */
    .print-header {
      display: block !important;
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #000;
    }

    .print-header h1 {
      margin: 0 0 5px 0;
      font-size: 24px;
      color: #000;
      font-weight: 700;
    }

    .print-header p {
      margin: 3px 0;
      font-size: 10px;
      color: #333;
    }

    /* Remove scrollbars */
    ::-webkit-scrollbar {
      display: none !important;
    }

    /* Customer info enhanced */
    .print-customer-info {
      display: block !important;
    }

    .print-customer-name {
      font-weight: 700 !important;
      font-size: 9px !important;
      color: #000 !important;
    }

    .print-customer-email {
      font-size: 7px !important;
      color: #666 !important;
    }

    /* Items hidden by default, shown in print */
    .screen-only {
      display: block;
    }

    .print-only {
      display: none;
    }

    @media print {
      .screen-only {
        display: none !important;
      }
      .print-only {
        display: block !important;
      }
    }
  }

  /* Print header - hidden by default */
  .print-header {
    display: none;
  }

  .print-items-detail,
  .print-address-full,
  .print-amount-breakdown {
    display: none;
  }
</style>

<div class="main-panel">
  <div class="content-wrapper">

    <!-- Print Header (only visible when printing) -->
    <div class="print-header">
      <h1>ORDERS REPORT</h1>
      <p><strong>Rihazain</strong></p>
      <p>kozhikode, KERALA , INDIA -680516</p>
      <p>Phone: +91 9512345678 | Email: info@company.com</p>
      <p style="margin-top: 10px;">Generated on: {{ current_date|default:"now"|date:"M d, Y h:i A" }}</p>
    </div>

    <!-- Page header -->
    <div class="page-header d-flex justify-content-between align-items-start mb-3 no-print">
      <div>
        <h3 class="page-title mb-1">Orders Management</h3>
        <p class="text-muted small">Complete order information and details</p>
      </div>

      <div class="d-flex align-items-center" style="gap:10px;">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0" style="background:transparent;border:none;padding:0;">
            <li class="breadcrumb-item active text-muted">Admin → Orders</li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Controls -->
    <div class="row mb-3 no-print">
      <div class="col-lg-8 col-md-12 d-flex control-row">
        <div class="filter-group btn-group" role="group" aria-label="Filter orders">
          <button type="button" class="btn btn-sm btn-outline-light active" data-filter="all">All</button>
          <button type="button" class="btn btn-sm btn-outline-light" data-filter="Pending">Pending</button>
          <button type="button" class="btn btn-sm btn-outline-light" data-filter="Processing">Processing</button>
          <button type="button" class="btn btn-sm btn-outline-light" data-filter="Shipped">Shipped</button>
          <button type="button" class="btn btn-sm btn-outline-light" data-filter="Delivered">Delivered</button>
          <button type="button" class="btn btn-sm btn-outline-light" data-filter="Cancelled">Cancelled</button>
        </div>

        <div class="input-group ml-3 searchOrder" style="max-width:420px;">
          <input id="searchOrder" type="search" class="form-control form-control-sm bg-transparent text-light"
            placeholder="Search Order ID, Customer, Email, Phone..." aria-label="Search orders">
          <div class="input-group-append">
            <button id="clearSearch" class="btn btn-sm btn-light" title="Clear search">✕</button>
          </div>
        </div>
      </div>

      <div class="col-lg-4 col-md-12 text-right d-flex justify-content-end" style="gap:8px;">
        <button id="exportExcel" class="btn btn-sm btn-gradient-success">
          <i class="mdi mdi-file-excel mr-1"></i> Export CSV
        </button>
        <button id="printBtn" class="btn btn-sm btn-gradient-info" onclick="window.print()">
          <i class="mdi mdi-printer mr-1"></i> Print
        </button>
      </div>
    </div>

    <!-- Orders table -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table id="ordersTable" class="table table-hover mb-0">
                <thead>
                  <tr>
                    <!-- <th style="width:44px;text-align:center;" class="no-print">
                      <input id="selectAll" type="checkbox" aria-label="Select all">
                    </th> -->
                    <th>ORDER ID</th>
                    <th>CUSTOMER</th>
                    <th>CONTACT</th>
                    <th>ADDRESS</th>
                    <th>ITEMS</th>
                    <th>AMOUNT</th>
                    <th>DATE</th>
                    <th class="screen-only">STATUS</th>
                    <th class="text-center no-print">ACTIONS</th>
                  </tr>
                </thead>

                <tbody>
                  {% for o in orders %}
                  <tr class="order-row" data-status="{{ o.status }}">
                    <!-- <td class="text-center no-print">
                      <input class="order-checkbox" type="checkbox" value="{{ o.id }}">
                    </td> -->

                    <td>
                      <span class="badge badge-info"
                        style="background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent);padding:6px 8px;border-radius:6px;">
                        #{{ o.id }}
                      </span>
                    </td>

                    <td>
                      <!-- Screen view -->
                      <!-- <div class="screen-only">
                        <div class="d-flex align-items-center">
                          <div>
                            <div class="font-weight-bold">{{ o.user.username }}</div>
                            <small class="text-muted">{{ o.user.email|truncatechars:30 }}</small>
                          </div>
                        </div>
                      </div> -->
                      
                      <!-- Print view -->
                      <div class="print-only print-customer-info">
                        <div class="print-customer-name">{{ o.user.username }}</div>
                        <div class="print-customer-email">{{ o.user.email }}</div>
                      </div>
                    </td>

                    <td>
                      <div class="small">
                        <div><i class="mdi mdi-phone text-success mr-1"></i>
                          {% if o.shippingaddress.phone %}
                          {{ o.shippingaddress.phone }}
                          {% elif o.user.profile.phone %}
                          {{ o.user.profile.phone }}
                          {% else %}
                          N/A
                          {% endif %}
                        </div>
                      </div>
                    </td>

                    <td>
                      <!-- Screen view -->
                      <div class="small text-muted screen-only">
                        <strong>{{ o.shippingaddress.full_name|default:o.user.username|truncatechars:20 }}</strong><br>
                        {{ o.shippingaddress.city|default:"N/A" }}, {{ o.shippingaddress.country|default:"N/A" }}
                      </div>
                      
                      <!-- Print view - Full address -->
                      <div class="print-only print-address-full">
                        <strong>{{ o.shippingaddress.full_name|default:o.user.username }}</strong>
                        <div>{{ o.shippingaddress.address_line|default:"Address not available" }}</div>
                        <div>{{ o.shippingaddress.city|default:"N/A" }}, {{ o.shippingaddress.postal_code|default:"" }}</div>
                        <div>{{ o.shippingaddress.country|default:"N/A" }}</div>
                      </div>
                    </td>

                    <td>
                      <!-- Screen view -->
                      <div class="screen-only text-center">
                        <span class="badge badge-info">{{ o.items.count }}</span>
                      </div>
                      
                      <!-- Print view - Detailed items -->
                      <div class="print-only print-items-detail">
                        <div style="font-weight: 700; margin-bottom: 4px; font-size: 9px;">{{ o.items.count }} Item(s):</div>
                        {% for item in o.items.all %}
                        <div class="print-item-row">
                          {% if item.product.images.first %}
                            <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}" class="print-item-image">
                          {% elif item.product.image %}
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="print-item-image">
                          {% else %}
                            <div class="print-item-image" style="background: #eee; display: flex; align-items: center; justify-content: center;">
                              <span style="font-size: 6px;">No Img</span>
                            </div>
                          {% endif %}
                          <div class="print-item-info">
                            <div class="print-item-name">{{ item.product.name|truncatechars:30 }}</div>
                            <div class="print-item-details">
                              Qty: {{ item.quantity }} × ₹{{ item.price|floatformat:2 }} = ₹{{ item.get_total|floatformat:2 }}
                            </div>
                          </div>
                        </div>
                        {% endfor %}
                      </div>
                    </td>

                    <td class="text-right">
                      <!-- Screen view -->
                      <div class="screen-only font-weight-bold text-success">
                        ₹ {{ o.total_price|floatformat:2 }}
                      </div>
                      
                      <!-- Print view - Amount breakdown -->
                      <div class="print-only print-amount-breakdown">
                        <div class="print-amount-total">₹{{ o.total_price|floatformat:2 }}</div>
                        <div class="print-amount-items">Subtotal: ₹{{ o.get_total|floatformat:2 }}</div>
                      </div>
                    </td>

                    <td>
                      <div class="small">
                        <strong>{{ o.created_at|date:"M d, Y" }}</strong><br>
                        <small class="text-muted">{{ o.created_at|date:"h:i A" }}</small>
                      </div>
                    </td>

                    <td class="screen-only">
                      {% if o.status == 'Delivered' %}
                      <span class="badge badge-success">DELIVERED</span>
                      {% elif o.status == 'Pending' %}
                      <span class="badge badge-warning">PENDING</span>
                      {% elif o.status == 'Processing' %}
                      <span class="badge badge-info">PROCESSING</span>
                      {% elif o.status == 'Shipped' %}
                      <span class="badge badge-info">SHIPPED</span>
                      {% elif o.status == 'Cancelled' %}
                      <span class="badge badge-danger">CANCELLED</span>
                      {% else %}
                      <span class="badge badge-info">{{ o.status }}</span>
                      {% endif %}
                    </td>

                    <td class="text-center no-print">
                      <button class="btn btn-sm btn-outline-primary" data-action="view" data-id="{{ o.id }}"
                        data-toggle="modal" data-target="#orderModal-{{ o.id }}" title="View">
                        <i class="mdi mdi-eye"></i>
                      </button>

                      <a href="{% url 'admin_order_update' o.id %}" class="btn btn-sm btn-outline-primary" title="Edit">
                        <i class="mdi mdi-pencil"></i>
                      </a>

                      <a href="{% url 'invoice' o.id %}" class="btn btn-sm btn-gradient-success" title="Invoice">
                        <i class="mdi mdi-file-document-outline"></i>
                      </a>
                      
                      <a href="{% url 'receipt' o.id %}" class="btn btn-sm btn-gradient-success" title="Receipt">
                        <i class="mdi mdi-receipt"></i>
                      </a>
                      
                      <button class="btn btn-sm btn-gradient-danger" onclick="deleteOrder({{ o.id }})" title="Delete">
                        <i class="mdi mdi-delete"></i>
                      </button>
                    </td>
                  </tr>
                  {% endfor %}

                  {% if orders|length == 0 %}
                  <tr>
                    <td colspan="10" class="text-center py-5 text-muted">
                      <i class="mdi mdi-cart-off mdi-36px mb-2"></i>
                      <div>No orders found</div>
                    </td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ORDER MODALS (keeping the same as before) -->
    <!-- ---------- ORDER MODALS ---------- -->
    {% for o in orders %}
    <div class="modal fade" id="orderModal-{{ o.id }}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Order #{{ o.id|stringformat:"05d" }} — Complete Details</h5>
            <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>

          <div class="modal-body">
            <div class="row mb-4">
              <!-- Customer Info -->
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <h6 class="text-primary mb-3"><i class="mdi mdi-account mr-2"></i>Customer Information</h6>
                    <table class="table table-sm table-borderless mb-0">
                      <tr>
                        <td class="text-muted">Name:</td>
                        <td><strong>{{ o.user.username }}</strong></td>
                      </tr>
                      <tr>
                        <td class="text-muted">Email:</td>
                        <td>{{ o.user.email }}</td>
                      </tr>
                      <tr>
                        <td class="text-muted">Phone:</td>
                        <td>
                          {% if o.shippingaddress.phone %}
                          {{ o.shippingaddress.phone }}
                          {% elif o.user.profile.phone %}
                          {{ o.user.profile.phone }}
                          {% else %}
                          Not provided
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <td class="text-muted">Customer ID:</td>
                        <td>#{{ o.user.id }}</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Shipping Address -->
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <h6 class="text-success mb-3"><i class="mdi mdi-map-marker mr-2"></i>Shipping Address</h6>
                    <address class="mb-0">
                      <strong>{{ o.shippingaddress.full_name|default:o.user.username }}</strong><br>
                      {{ o.shippingaddress.address_line|default:"Address not available" }}<br>
                      {{ o.shippingaddress.city|default:"N/A" }}, {{ o.shippingaddress.postal_code|default:"" }}<br>
                      {{ o.shippingaddress.country|default:"N/A" }}<br>
                      {% if o.shippingaddress.phone %}
                      <i class="mdi mdi-phone text-success"></i> {{ o.shippingaddress.phone }}
                      {% endif %}
                    </address>
                  </div>
                </div>
              </div>

              <!-- Order Summary -->
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <h6 class="text-info mb-3"><i class="mdi mdi-information mr-2"></i>Order Summary</h6>
                    <table class="table table-sm table-borderless mb-0">
                      <tr>
                        <td class="text-muted">Order Status:</td>
                        <td>
                          {% if o.status == 'Delivered' %}
                          <span class="badge badge-success">Delivered</span>
                          {% elif o.status == 'Pending' %}
                          <span class="badge badge-warning">Pending</span>
                          {% elif o.status == 'Processing' %}
                          <span class="badge badge-info">Processing</span>
                          {% elif o.status == 'Shipped' %}
                          <span class="badge badge-primary">Shipped</span>
                          {% else %}
                          <span class="badge badge-danger">{{ o.status }}</span>
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <td class="text-muted">Payment Status:</td>
                        <td>
                          {% if o.is_paid %}
                          <span class="badge badge-success"><i class="mdi mdi-check"></i> Paid</span>
                          {% else %}
                          <span class="badge badge-warning"><i class="mdi mdi-alert"></i> Unpaid</span>
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <td class="text-muted">Total Items:</td>
                        <td><strong>{{ o.items.count }}</strong></td>
                      </tr>
                      <tr>
                        <td class="text-muted">Order Date:</td>
                        <td>{{ o.created_at|date:"M d, Y h:i A" }}</td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Order Items -->
            <div class="card">
              <div class="card-body">
                <h6 class="text-dark mb-3"><i class="mdi mdi-cart mr-2"></i>Order Items ({{ o.items.count }} Products)
                </h6>
                <div class="table-responsive">
                  <table class="table table-bordered table-striped mb-0">
                    <thead class="thead-dark">
                      <tr>
                        <th width="5%" class="text-center">#</th>
                        <th width="10%">Image</th>
                        <th width="40%">Product Details</th>
                        <th width="15%" class="text-center">Unit Price</th>
                        <th width="10%" class="text-center">Quantity</th>
                        <th width="20%" class="text-right">Subtotal</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in o.items.all %}
                      <tr>
                        <td class="text-center align-middle">{{ forloop.counter }}</td>
                        <td class="text-center align-middle">

                          {% if item.product.images.first %}
                          <!-- First gallery image -->
                          <img src="{{ item.product.images.first.image.url }}" alt="{{ item.product.name }}"
                            class="img-thumbnail" style="width: 60px; height: 60px; object-fit: cover;">

                          {% elif item.product.image %}
                          <!-- Primary product image -->
                          <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="img-thumbnail"
                            style="width: 60px; height: 60px; object-fit: cover;">

                          {% else %}
                          <!-- No image -->
                          <div class="bg-dark text-secondary d-flex align-items-center justify-content-center"
                            style="width: 60px; height: 60px; border-radius: 6px;">
                            <i class="mdi mdi-image-off mdi-24px"></i>
                          </div>
                          {% endif %}

                        </td>

                        <td class="align-middle">
                          <h6 class="mb-1 font-weight-bold">{{ item.product.name }}</h6>
                          {% if item.product.category %}
                          <small class="text-muted d-block">
                            <strong>Category:</strong> {{ item.product.category.name }}
                          </small>
                          {% endif %}
                          {% if item.product.description %}
                          <small class="text-muted d-block mt-1">{{ item.product.description|truncatechars:60 }}</small>
                          {% endif %}
                        </td>
                        <td class="text-center align-middle">
                          <h6 class="mb-0 text-success">${{ item.price|floatformat:2 }}</h6>
                        </td>
                        <td class="text-center align-middle">
                          <span class="badge badge-secondary badge-pill px-3 py-2">
                            <strong>{{ item.quantity }}</strong>
                          </span>
                        </td>
                        <td class="text-right align-middle">
                          <h5 class="mb-0 font-weight-bold text-dark">${{ item.get_total|floatformat:2 }}</h5>
                        </td>
                      </tr>
                      {% empty %}
                      <tr>
                        <td colspan="6" class="text-center text-muted py-4">No items in this order</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                    <tfoot class="bg-light">
                      <tr>
                        <td colspan="5" class="text-right font-weight-bold">
                          <h6 class="mb-0">Subtotal:</h6>
                        </td>
                        <td class="text-right">
                          <h6 class="mb-0 font-weight-bold">${{ o.get_total|floatformat:2 }}</h6>
                        </td>
                      </tr>
                      <tr class="bg-primary text-white">
                        <td colspan="5" class="text-right">
                          <h5 class="mb-0 font-weight-bold">Grand Total:</h5>
                        </td>
                        <td class="text-right">
                          <h4 class="mb-0 font-weight-bold">${{ o.total_price|floatformat:2 }}</h4>
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-light" data-dismiss="modal">Close</button>
            <a href="{% url 'admin_order_update' o.id %}" class="btn btn-gradient-primary">
              <i class="mdi mdi-pencil mr-1"></i> Edit Order
            </a>
            <a href="{% url 'invoice' o.id %}" class="btn btn-sm btn-gradient-success" title="Invoice">
              <i class="mdi mdi-file-document-outline"></i>
              Invoice
            </a>
            <a href="{% url 'receipt' o.id %}" class="btn btn-sm btn-gradient-success" title="Receipt">
              <i class="mdi mdi-receipt"></i> Receipt
            </a>

          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    <!-- end modals -->

  </div>
</div>

<script>
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  function searchTable() {
    const q = ($('#searchOrder')?.value || '').trim().toUpperCase();
    const rows = $$('#ordersTable tbody tr');
    rows.forEach(r => {
      if (!r.closest('tbody')) return;
      const text = (r.textContent || '').toUpperCase();
      r.style.display = text.indexOf(q) > -1 ? '' : 'none';
    });
  }

  function filterOrders(status) {
    const rows = $$('#ordersTable tbody tr');
    rows.forEach(r => {
      if (!status || status === 'all') { r.style.display = ''; return; }
      const rowStatus = (r.dataset.status || '').trim();
      r.style.display = rowStatus === status ? '' : 'none';
    });
  }

  function toggleSelectAll(checked) {
    $$('.order-checkbox').forEach(cb => cb.checked = checked);
  }

  function exportTableToCSV() {
    const rows = $$('#ordersTable tbody tr');
    const csv = [];
    rows.forEach(r => {
      if (r.style.display === 'none') return;
      const cols = Array.from(r.querySelectorAll('td'));
      const values = cols.map((c, idx) => {
        if (idx === cols.length - 1) return '';
        let txt = (c.innerText || '').replace(/"/g, '""').trim();
        return `"${txt}"`;
      });
      csv.push(values.join(','));
    });
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `orders_${(new Date()).toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  function deleteOrder(orderId) {
    if (!confirm('Delete order #' + orderId + '? This cannot be undone.')) return;
    window.location.href = `/admin/orders/${orderId}/delete/`;
  }

  function initTooltips() {
    try {
      if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        const t = document.querySelectorAll('[data-toggle="tooltip"]');
        t.forEach(el => new bootstrap.Tooltip(el));
      } else if (window.jQuery && typeof jQuery.fn.tooltip === 'function') {
        $('[data-toggle="tooltip"]').tooltip();
      }
    } catch (e) {
      console.warn('Tooltips init skipped', e);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const search = $('#searchOrder');
    if (search) {
      search.addEventListener('input', searchTable);
      const clear = $('#clearSearch');
      if (clear) clear.addEventListener('click', () => { search.value = ''; searchTable(); });
    }

    const fb = document.querySelectorAll('[data-filter]');
    fb.forEach(b => {
      b.addEventListener('click', function () {
        fb.forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        filterOrders(this.getAttribute('data-filter'));
      });
    });

    const selectAll = $('#selectAll');
    if (selectAll) selectAll.addEventListener('change', (e) => toggleSelectAll(e.target.checked));

    const exportBtn = $('#exportExcel');
    if (exportBtn) exportBtn.addEventListener('click', exportTableToCSV);

    initTooltips();

    setTimeout(() => {
      $$('.alert').forEach(a => { a.style.transition = 'opacity .4s'; a.style.opacity = '0'; setTimeout(() => a.remove(), 450); });
    }, 4500);
  });
</script>
{% endblock %}